<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>SDN(三) RYU控制器相关笔记 | Liwei&#39;s Page</title>
  <meta name="description" content="1 引言积跬步以至千里，积怠情以至深渊。 RYU是由日本NTT公司研发的开源SDN控制器，由Python语言编写。支持OpenFlow1.0、1.2、1.3、1.4和1.5版本的协议。本人将在此文档中持续更新关于RYU控制器的一些学习笔记，包括RYU的运行流程、部分源码解读、应用开发以及RYU具体使用。望读者能在共同学习的同时，批评指正。 2 RYU源码解读2.1 RYU源文件目录结构ryu&#x2F;ry">
<meta property="og:type" content="article">
<meta property="og:title" content="SDN(三) RYU控制器相关笔记">
<meta property="og:url" content="http://www.li2ui2.xyz/2020/11/20/SDN-%E4%B8%89-RYU%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Liwei&#39;s Tech Blog">
<meta property="og:description" content="1 引言积跬步以至千里，积怠情以至深渊。 RYU是由日本NTT公司研发的开源SDN控制器，由Python语言编写。支持OpenFlow1.0、1.2、1.3、1.4和1.5版本的协议。本人将在此文档中持续更新关于RYU控制器的一些学习笔记，包括RYU的运行流程、部分源码解读、应用开发以及RYU具体使用。望读者能在共同学习的同时，批评指正。 2 RYU源码解读2.1 RYU源文件目录结构ryu&#x2F;ry">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191110124754396.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA5NDU4OQ==,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191107214500356.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA5NDU4OQ==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191107214649427.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA5NDU4OQ==,size_16,color_FFFFFF,t_70">
<meta property="article:published_time" content="2020-11-20T05:55:28.000Z">
<meta property="article:modified_time" content="2020-11-20T06:07:19.171Z">
<meta property="article:author" content="Li Wei">
<meta property="article:tag" content="软件定义网络">
<meta property="article:tag" content="RYU控制器">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20191110124754396.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA5NDU4OQ==,size_16,color_FFFFFF,t_70#pic_center">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.li2ui2.xyz/2020/11/20/SDN-%E4%B8%89-RYU%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Liwei&#39;s Tech Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.2.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/li2ui2" target="_blank">
          <img class="img-circle img-rotate" src="/images/liwei.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">你的老李同学</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">R&amp;D Engineer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Hangzhou, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/li2ui2" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/">人工智能</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E5%B7%A7/">技巧</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A0%91%E8%8E%93%E6%B4%BE/">树莓派</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">版本控制</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C/">软件定义网络</a><span class="category-list-count">7</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Facenet%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%AE%97%E6%B3%95/" rel="tag">Facenet人脸识别算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gephi%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B9%B3%E5%8F%B0/" rel="tag">Gephi可视化平台</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MTCNN%E4%BA%BA%E8%84%B8%E6%A3%80%E6%B5%8B%E7%AE%97%E6%B3%95/" rel="tag">MTCNN人脸检测算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mininet/" rel="tag">Mininet</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mininet-WiFi/" rel="tag">Mininet-WiFi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netgear-R6220%E4%BA%A4%E6%8D%A2%E6%9C%BA/" rel="tag">Netgear R6220交换机</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netgear%E8%B7%AF%E7%94%B1%E5%99%A8/" rel="tag">Netgear路由器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCV/" rel="tag">OpenCV</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenFlow%E4%BA%A4%E6%8D%A2%E6%9C%BA/" rel="tag">OpenFlow交换机</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenWRT/" rel="tag">OpenWRT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenvSwitch%E4%BA%A4%E6%8D%A2%E6%9C%BA/" rel="tag">OpenvSwitch交换机</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/POX%E6%8E%A7%E5%88%B6%E5%99%A8/" rel="tag">POX控制器</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pycharm/" rel="tag">Pycharm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RYU%E6%8E%A7%E5%88%B6%E5%99%A8/" rel="tag">RYU控制器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TP-LINK-TL-MR3420%E4%BA%A4%E6%8D%A2%E6%9C%BA/" rel="tag">TP-LINK TL-MR3420交换机</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arp%E5%8D%8F%E8%AE%AE/" rel="tag">arp协议</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/icmp%E5%8D%8F%E8%AE%AE/" rel="tag">icmp协议</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ping%E5%91%BD%E4%BB%A4%E5%8E%9F%E7%90%86/" rel="tag">ping命令原理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag">树莓派</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E4%BB%BF%E7%9C%9F%E5%99%A8/" rel="tag">网络仿真器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C/" rel="tag">软件定义网络</a><span class="tag-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Facenet%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%AE%97%E6%B3%95/" style="font-size: 13px;">Facenet人脸识别算法</a> <a href="/tags/Gephi%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B9%B3%E5%8F%B0/" style="font-size: 13px;">Gephi可视化平台</a> <a href="/tags/Git/" style="font-size: 13px;">Git</a> <a href="/tags/MTCNN%E4%BA%BA%E8%84%B8%E6%A3%80%E6%B5%8B%E7%AE%97%E6%B3%95/" style="font-size: 13px;">MTCNN人脸检测算法</a> <a href="/tags/Mininet/" style="font-size: 13px;">Mininet</a> <a href="/tags/Mininet-WiFi/" style="font-size: 13px;">Mininet-WiFi</a> <a href="/tags/MongoDB/" style="font-size: 13px;">MongoDB</a> <a href="/tags/Netgear-R6220%E4%BA%A4%E6%8D%A2%E6%9C%BA/" style="font-size: 13px;">Netgear R6220交换机</a> <a href="/tags/Netgear%E8%B7%AF%E7%94%B1%E5%99%A8/" style="font-size: 13px;">Netgear路由器</a> <a href="/tags/OpenCV/" style="font-size: 13px;">OpenCV</a> <a href="/tags/OpenFlow%E4%BA%A4%E6%8D%A2%E6%9C%BA/" style="font-size: 13.33px;">OpenFlow交换机</a> <a href="/tags/OpenWRT/" style="font-size: 13px;">OpenWRT</a> <a href="/tags/OpenvSwitch%E4%BA%A4%E6%8D%A2%E6%9C%BA/" style="font-size: 13px;">OpenvSwitch交换机</a> <a href="/tags/POX%E6%8E%A7%E5%88%B6%E5%99%A8/" style="font-size: 13.33px;">POX控制器</a> <a href="/tags/Pycharm/" style="font-size: 13px;">Pycharm</a> <a href="/tags/Python/" style="font-size: 13.67px;">Python</a> <a href="/tags/RYU%E6%8E%A7%E5%88%B6%E5%99%A8/" style="font-size: 13px;">RYU控制器</a> <a href="/tags/TP-LINK-TL-MR3420%E4%BA%A4%E6%8D%A2%E6%9C%BA/" style="font-size: 13px;">TP-LINK TL-MR3420交换机</a> <a href="/tags/arp%E5%8D%8F%E8%AE%AE/" style="font-size: 13px;">arp协议</a> <a href="/tags/icmp%E5%8D%8F%E8%AE%AE/" style="font-size: 13px;">icmp协议</a> <a href="/tags/ping%E5%91%BD%E4%BB%A4%E5%8E%9F%E7%90%86/" style="font-size: 13px;">ping命令原理</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 13.33px;">树莓派</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E4%BB%BF%E7%9C%9F%E5%99%A8/" style="font-size: 13px;">网络仿真器</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 13px;">计算机网络</a> <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C/" style="font-size: 14px;">软件定义网络</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">6</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%8A%80%E5%B7%A7/">技巧</a>
              </p>
              <p class="item-title">
                <a href="/2021/01/04/Netgear%E8%B7%AF%E7%94%B1%E5%99%A8%E6%95%91%E7%A0%96%E6%95%99%E7%A8%8B/" class="title">Netgear路由器救砖教程</a>
              </p>
              <p class="item-date">
                <time datetime="2021-01-04T07:52:06.000Z" itemprop="datePublished">2021-01-04</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%A0%91%E8%8E%93%E6%B4%BE/">树莓派</a>
              </p>
              <p class="item-title">
                <a href="/2021/01/04/%E6%A0%91%E8%8E%93%E6%B4%BE-%E4%BA%8C-%E6%A0%91%E8%8E%93%E6%B4%BE%E5%BC%80%E5%90%AFVNC%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1/" class="title">树莓派(二) 树莓派开启VNC远程连接服务</a>
              </p>
              <p class="item-date">
                <time datetime="2021-01-04T07:48:17.000Z" itemprop="datePublished">2021-01-04</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%A0%91%E8%8E%93%E6%B4%BE/">树莓派</a>
              </p>
              <p class="item-title">
                <a href="/2021/01/04/%E6%A0%91%E8%8E%93%E6%B4%BE-%E4%B8%80-%E6%A0%91%E8%8E%93%E6%B4%BE%E4%B8%AD%E7%9A%84%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/" class="title">树莓派(一) 树莓派中的网络配置问题</a>
              </p>
              <p class="item-date">
                <time datetime="2021-01-04T07:47:49.000Z" itemprop="datePublished">2021-01-04</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%8A%80%E5%B7%A7/">技巧</a>
              </p>
              <p class="item-title">
                <a href="/2021/01/04/Pytharm%E4%B8%AD%E5%85%B3%E4%BA%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E7%9A%84%E4%BD%BF%E7%94%A8/" class="title">Pytharm中关于版本控制的使用</a>
              </p>
              <p class="item-date">
                <time datetime="2021-01-04T07:45:35.000Z" itemprop="datePublished">2021-01-04</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a>
              </p>
              <p class="item-title">
                <a href="/2021/01/04/Python-%E5%9B%9B-Python%E4%B8%AD%E7%9A%84%E9%97%AD%E5%8C%85%E5%87%BD%E6%95%B0%E3%80%81%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E5%92%8C%E8%A3%85%E9%A5%B0%E5%99%A8/" class="title">Python(四) Python中的闭包函数、可变参数和装饰器</a>
              </p>
              <p class="item-date">
                <time datetime="2021-01-04T07:43:54.000Z" itemprop="datePublished">2021-01-04</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-SDN-三-RYU控制器相关笔记" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      SDN(三) RYU控制器相关笔记
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2020/11/20/SDN-%E4%B8%89-RYU%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/" class="article-date">
	  <time datetime="2020-11-20T05:55:28.000Z" itemprop="datePublished">2020-11-20</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C/">软件定义网络</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/RYU%E6%8E%A7%E5%88%B6%E5%99%A8/" rel="tag">RYU控制器</a>, <a class="article-tag-link-link" href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C/" rel="tag">软件定义网络</a>
  </span>


        

	<span class="article-read hidden-xs">
    	<i class="icon icon-eye-fill" aria-hidden="true"></i>
    	<span id="/2020/11/20/SDN-%E4%B8%89-RYU%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/" class="leancloud_visitors"  data-flag-title="SDN(三) RYU控制器相关笔记">
			<span class="leancloud-visitors-count">0</span>
		</span>
    </span>

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/11/20/SDN-%E4%B8%89-RYU%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="1-引言"><a href="#1-引言" class="headerlink" title="1 引言"></a>1 引言</h1><p>积跬步以至千里，积怠情以至深渊。</p>
<p>RYU是由日本NTT公司研发的开源SDN控制器，由Python语言编写。支持OpenFlow1.0、1.2、1.3、1.4和1.5版本的协议。本人将在此文档中持续更新关于RYU控制器的一些学习笔记，包括RYU的运行流程、部分源码解读、应用开发以及RYU具体使用。望读者能在共同学习的同时，批评指正。</p>
<h1 id="2-RYU源码解读"><a href="#2-RYU源码解读" class="headerlink" title="2 RYU源码解读"></a>2 RYU源码解读</h1><h2 id="2-1-RYU源文件目录结构"><a href="#2-1-RYU源文件目录结构" class="headerlink" title="2.1 RYU源文件目录结构"></a>2.1 RYU源文件目录结构</h2><p><strong>ryu/ryu目录下的主要目录内容如下：</strong></p>
<p><strong>(1) base：</strong> </p>
<p>base中有一个非常重要的文件：app_manager.py，其作用是RYU应用的管理中心，即对其他组件的管理。用于加载RYU应用程序，接受从APP发送过来的信息，同时也完成消息的路由。<strong>会被ryu-manager自动调用。</strong></p>
<p>其主要的函数有app注册、注销、查找、并定义了RyuApp基类，定义了RYUAPP的基本属性。包含name, threads, events, event_handlers和observers等成员，以及对应的许多基本函数。如：start(), stop()等。</p>
<p>这个文件中还定义了<strong>AppManager</strong>基类，用于管理APP。定义了加载APP等函数。不过如果仅仅是开发APP的话，这个类可以不必关心。</p>
<p><strong>(2) controller：</strong> <strong>实现controller和交换机之间的互联和事件处理</strong></p>
<p>controller文件夹中许多非常重要的文件，如events.py, ofp_handler.py, controller.py等。<br>在controller.py中定义了OpenFlowController基类，是控制器组件，管理与OF交换机连接的安全通道，接收OF消息，调用ofp_events，并发布相应的“事件”，以触发订阅了该“事件”的组件的处理逻辑。</p>
<p>在ofp_handler.py中定义了基本的handler，完成了基本的如：握手，错误信息处理和keep alive 等功能。更多的如packet_in_handler应该在app中定义。</p>
<p>在dpset.py文件中，定义了交换机端的一些消息，如端口状态信息等，用于描述和操作交换机。如添加端口，删除端口等操作。</p>
<p><strong>(3) lib：网络基本协议的实现和使用</strong></p>
<p>lib中定义了我们需要使用到的基本的数据结构，如dpid, mac和ip等数据结构。在lib/packet目录下，还定义了许多网络协议，如ICMP, DHCP, MPLS和IGMP等协议内容。而每一个数据包的类中都有parser和serialize两个函数。用于解析和序列化数据包。</p>
<p>lib目录下，还有ovs, netconf目录，对应的目录下有一些定义好的数据类型</p>
<p><strong>(4) ofproto</strong></p>
<p>在这个目录下，基本分为两类文件，一类是协议的数据结构定义，另一类是协议解析，也即数据包处理函数文件。</p>
<p><strong>(5) topology：交换机和链路的查询模块</strong></p>
<p>包含了switches.py等文件，基本定义了一套交换机的数据结构。event.py定义了交换上的事件。dumper.py定义了获取网络拓扑的内容。最后api.py向上提供了一套调用topology目录中定义函数的接口。</p>
<p><strong>(6) contrib：第三方库</strong></p>
<p>这个文件夹主要存放的是开源社区贡献者的代码。</p>
<p><strong>(7) cmd：入口函数</strong></p>
<p>定义了RYU的命令系统，为controller的执行创建环境，接收和处理相关命令</p>
<p><strong>(8) services</strong></p>
<p>完成了BGP (路由技术) 和vrrp (交换技术) 的实现</p>
<p><strong>(9) tests</strong><br>tests目录下存放了单元测试以及整合测试的代码。</p>
<h2 id="2-2-ryu-app目录下源码解读及相关API的使用"><a href="#2-2-ryu-app目录下源码解读及相关API的使用" class="headerlink" title="2.2 ryu/app目录下源码解读及相关API的使用"></a>2.2 ryu/app目录下源码解读及相关API的使用</h2><h3 id="2-2-1-ryu-app-simple-switch-13-py实现功能为：传统的2层交换机策略"><a href="#2-2-1-ryu-app-simple-switch-13-py实现功能为：传统的2层交换机策略" class="headerlink" title="2.2.1 ryu/app/simple_switch_13.py实现功能为：传统的2层交换机策略"></a>2.2.1 ryu/app/simple_switch_13.py实现功能为：传统的2层交换机策略</h3><p>对于OpenFlow交换机，接受RYU控制器的指令，并达到以下功能：对于接收到的数据包进行修改或针对指定端口进行转发；对于接收到的数据包进行转发到控制器的动作（packet-in）；对于接收到来自控制器的数据包进行转发到指定的端口（packet-out）</p>
<p>对于RYU来说，接收到任何一个OpenFlow消息，都会产生一个相对应事件，因此RYU应用必须实现事件管理以处理相对应的事件。</p>
<p><strong>NT：</strong> simple_switch.py、 simple_switch_12.py、simple_switch_13.py、simple_switch_14.py和simple_switch_15.py分别对应OpenFlow1.0、1.2、1.4、1.5版本的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ryu.base <span class="keyword">import</span> app_manager</span><br><span class="line"><span class="keyword">from</span> ryu.controller <span class="keyword">import</span> ofp_event</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> CONFIG_DISPATCHER, MAIN_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> set_ev_cls</span><br><span class="line"><span class="keyword">from</span> ryu.ofproto <span class="keyword">import</span> ofproto_v1_3</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> packet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ethernet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ether_types</span><br><span class="line"></span><br><span class="line"><span class="comment"># 继承ryu.base.app_manager.RyuApp</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSwitch13</span>(<span class="params">app_manager.RyuApp</span>):</span></span><br><span class="line">    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]  <span class="comment"># 指定OpenFlow 1.3版本</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SimpleSwitch13, self).__init__(*args, **kwargs)</span><br><span class="line">        self.mac_to_port = &#123;&#125;  <span class="comment"># 定义MAC地址列表</span></span><br><span class="line">	<span class="comment"># set_ev_cls指定事件类别得以接受消息和交换机状态作为参数</span></span><br><span class="line">	<span class="comment"># 其中事件类别名称为ryu.controller.ofp_event.EventOFP+&lt;OpenFlow消息名称&gt;</span></span><br><span class="line">	<span class="comment"># 例如：在 Packet-In 消息的状态下的事件名称为EventOFPPacketIn</span></span><br><span class="line">	<span class="comment"># 对于交换机的状态来说，可指定以下中的一项</span></span><br><span class="line">	<span class="comment"># ryu.controller.handler.HANDSHAKE_DISPATCHER 交换 HELLO 消息</span></span><br><span class="line">	<span class="comment"># ryu.controller.handler.CONFIG_DISPATCHER	  接收SwitchFeatures消息</span></span><br><span class="line">	<span class="comment"># ryu.controller.handler.MAIN_DISPATCHER	  一般状态</span></span><br><span class="line">	<span class="comment"># ryu.controller.handler.DEAD_DISPATCHER	  连线中断</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">switch_features_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">    	<span class="comment"># ev.msg 是用来存储对应事件的 OpenFlow 消息类别实体</span></span><br><span class="line">    	<span class="comment"># msg.datapath是用来存储OpenFlow交换机的 ryu.controller.controller.Datapath 类别所对应的实体</span></span><br><span class="line">        datapath = ev.msg.datapath  </span><br><span class="line">        ofproto = datapath.ofproto  <span class="comment"># ofproto表示使用的OpenFlow版本所对应的ryu.ofproto.ofproto_v1_3</span></span><br><span class="line">        parser = datapath.ofproto_parser  <span class="comment"># 和ofproto一样，有对应版本ryu.ofproto.ofproto_v1_3_parser</span></span><br><span class="line">        </span><br><span class="line">		<span class="comment"># 下发table-miss流表项，让交换机对于不会处理的数据包通过packet-in消息上交给Ryu控制器！！！</span></span><br><span class="line">        <span class="comment"># 匹配数据包</span></span><br><span class="line">        <span class="comment"># 若数据包没有 match 任何一个普通 Flow Entry 时，则触发 Packet-In</span></span><br><span class="line">        match = parser.OFPMatch()  </span><br><span class="line">        <span class="comment"># 通过预留端口ofproto.OFPP_CONTROLLER，将packet-in消息发送给controller，并通过ofproto.OFPCML_NO_BUFFE指明Racket-in消息的原因是table miss</span></span><br><span class="line">        actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,</span><br><span class="line">                                          ofproto.OFPCML_NO_BUFFER)]</span><br><span class="line">        <span class="comment"># 执行 add_flow() 方法以发送 Flow Mod 消息</span></span><br><span class="line">        self.add_flow(datapath, <span class="number">0</span>, match, actions)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_flow</span>(<span class="params">self, datapath, priority, match, actions, buffer_id=<span class="literal">None</span></span>):</span></span><br><span class="line">    	<span class="comment"># 新增流表项</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">		<span class="comment"># Apply Actions 是用来设定那些必须立即执行的 action 所使用</span></span><br><span class="line">        inst = [parser.OFPInstructionActions(ofproto.OFPIT_APPLY_ACTIONS,</span><br><span class="line">                                             actions)]</span><br><span class="line">        <span class="comment"># 通过 Flow Mod 消息将 Flow Entry 新增到 Flow table 中</span></span><br><span class="line">        <span class="keyword">if</span> buffer_id:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, buffer_id=buffer_id,</span><br><span class="line">                                    priority=priority, match=match,</span><br><span class="line">                                    instructions=inst)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, priority=priority,</span><br><span class="line">                                    match=match, instructions=inst)</span><br><span class="line">        datapath.send_msg(mod)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPPacketIn, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_packet_in_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        <span class="comment"># If you hit this you might want to increase</span></span><br><span class="line">        <span class="comment"># the &quot;miss_send_length&quot; of your switch</span></span><br><span class="line">        <span class="keyword">if</span> ev.msg.msg_len &lt; ev.msg.total_len:</span><br><span class="line">            self.logger.debug(<span class="string">&quot;packet truncated: only %s of %s bytes&quot;</span>,</span><br><span class="line">                              ev.msg.msg_len, ev.msg.total_len)</span><br><span class="line">        <span class="comment"># 为了接收处理未知目的地的数据包，需要执行Packet-In 事件管理</span></span><br><span class="line">        msg = ev.msg  <span class="comment"># 每一个事件类ev中都有msg成员，用于携带触发事件的数据包</span></span><br><span class="line">        datapath = msg.datapath  <span class="comment"># 已经格式化的msg其实就是一个packet_in报文，msg.datapath直接可以获得packet_in报文的datapath结构</span></span><br><span class="line">        <span class="comment"># datapath用于描述一个交换网桥，也是和控制器通信的实体单元。</span></span><br><span class="line">        <span class="comment"># datapath.send_msg()函数用于发送数据到指定datapath。</span></span><br><span class="line">        <span class="comment"># 通过datapath.id可获得dpid数据。</span></span><br><span class="line">        ofproto = datapath.ofproto  <span class="comment"># datapath.ofproto对象是一个OpenFlow协议数据结构的对象，成员包含OpenFlow协议的数据结构，如动作类型OFPP_FLOOD</span></span><br><span class="line">        parser = datapath.ofproto_parser  <span class="comment"># datapath.ofp_parser则是一个按照OpenFlow解析的数据结构。</span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># 更新Mac地址表</span></span><br><span class="line">        in_port = msg.match[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        pkt = packet.Packet(msg.data)</span><br><span class="line">        eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> eth.ethertype == ether_types.ETH_TYPE_LLDP:</span><br><span class="line">            <span class="comment"># ignore lldp packet</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        dst = eth.dst</span><br><span class="line">        src = eth.src</span><br><span class="line"></span><br><span class="line">        dpid = datapath.<span class="built_in">id</span></span><br><span class="line">        self.mac_to_port.setdefault(dpid, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">        self.logger.info(<span class="string">&quot;packet in %s %s %s %s&quot;</span>, dpid, src, dst, in_port)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># learn a mac address to avoid FLOOD next time.</span></span><br><span class="line">        self.mac_to_port[dpid][src] = in_port</span><br><span class="line"></span><br><span class="line">		<span class="comment"># 判断转发的数据包的连接端口</span></span><br><span class="line">		<span class="comment"># 目的 MAC 位址若存在于 MAC 地址表，则判断该连接端口号码为输出。</span></span><br><span class="line">		<span class="comment"># 反之若不存在于 MAC 地址表则 OUTPUT action 类别的实体并生成 flooding（ OFPP_FLOOD ）给目的连接端口使用。</span></span><br><span class="line">        <span class="keyword">if</span> dst <span class="keyword">in</span> self.mac_to_port[dpid]:</span><br><span class="line">            out_port = self.mac_to_port[dpid][dst]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            out_port = ofproto.OFPP_FLOOD</span><br><span class="line"></span><br><span class="line">        actions = [parser.OFPActionOutput(out_port)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># install a flow to avoid packet_in next time</span></span><br><span class="line">        <span class="keyword">if</span> out_port != ofproto.OFPP_FLOOD:</span><br><span class="line">            match = parser.OFPMatch(in_port=in_port, eth_dst=dst, eth_src=src)</span><br><span class="line">            <span class="comment"># verify if we have a valid buffer_id, if yes avoid to send both</span></span><br><span class="line">            <span class="comment"># flow_mod &amp; packet_out</span></span><br><span class="line">            <span class="keyword">if</span> msg.buffer_id != ofproto.OFP_NO_BUFFER:</span><br><span class="line">                self.add_flow(datapath, <span class="number">1</span>, match, actions, msg.buffer_id)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.add_flow(datapath, <span class="number">1</span>, match, actions)</span><br><span class="line"></span><br><span class="line">		<span class="comment"># 在 MAC 地址表中找寻目的 MAC 地址，若是有找到则发送 Packet-Out 讯息，并且转送数据包。</span></span><br><span class="line">        data = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:</span><br><span class="line">            data = msg.data</span><br><span class="line"></span><br><span class="line">        out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,</span><br><span class="line">                                  in_port=in_port, actions=actions, data=data)</span><br><span class="line">        datapath.send_msg(out)</span><br></pre></td></tr></table></figure>
<p>可结合Mininet进行测试，相关操作如下：<br>创建topo：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mn --topo single,3 --mac --switch ovsk --controller remote -x</span><br></pre></td></tr></table></figure>
<p>查看ovs-vswitchd的配置信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl show</span><br></pre></td></tr></table></figure>
<p>查看datapath的信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-dpctl show </span><br></pre></td></tr></table></figure>
<p>设定交换机s1的Openflow版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl set Bridge s1 protocols=OpenFlow13</span><br></pre></td></tr></table></figure>
<p>查看交换机s1的流表信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-ofctl -O OpenFlow13 dump-flows s1</span><br></pre></td></tr></table></figure>
<p>主机h1网络抓包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -en -i h1-eth0 </span><br></pre></td></tr></table></figure>
<p><strong><em>NT：实验过程可结合ifconfig 命令用来查看和配置网络设备！！！例如：</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 up        # 启动 &lt;br&gt;ifcfg etho up         # 启动</span><br><span class="line">ifconfig eth0 down      # 关闭&lt;br&gt;ifcfg eth0 down        # 关闭</span><br><span class="line">ifconfig eth0 hw ether 00:AA:BB:CC:DD:EE                # 修改MAC地址</span><br><span class="line">ifconfig eth0 reload    # 重启</span><br><span class="line">ifconfig eth0 add 33ffe:3240:800:1005::2/64              # 为网卡eth0配置IPv6地址 </span><br><span class="line">ifconfig eth0 del 33ffe:3240:800:1005::2/64              # 为网卡eth0删除IPv6地址</span><br><span class="line">ifconfig eth0 192.168.25.166 netmask 255.255.255.0 up    # 为网卡eth0配置IPv4地址</span><br><span class="line">ifconfig eth0:ws arp									 # 启用ARP协议</span><br><span class="line">ifconfig eth0:ws -arp									 # 关闭ARP协议</span><br><span class="line">ifconfig eth0 mtu 1500									 # 设置最大传输单元</span><br></pre></td></tr></table></figure>


<h3 id="2-2-2-ryu-app-simple-monitor-13-py实现功能为：定期检查网络状态"><a href="#2-2-2-ryu-app-simple-monitor-13-py实现功能为：定期检查网络状态" class="headerlink" title="2.2.2 ryu/app/simple_monitor_13.py实现功能为：定期检查网络状态"></a>2.2.2 ryu/app/simple_monitor_13.py实现功能为：定期检查网络状态</h3><p>当网络发生异常时，需快速找到原因，并且尽快回复原状。而找出网络中的错误、发现真正的原因需要清楚地知道网络地状态，假设网络中某个端口正处于高流量的状态，不论是因为它是一个不正常的状态或是任何原因导致，变成一个由于没有持续监控所发生的问题。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> attrgetter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ryu.app <span class="keyword">import</span> simple_switch_13</span><br><span class="line"><span class="keyword">from</span> ryu.controller <span class="keyword">import</span> ofp_event</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> MAIN_DISPATCHER, DEAD_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> set_ev_cls</span><br><span class="line"><span class="keyword">from</span> ryu.lib <span class="keyword">import</span> hub</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleMonitor13</span>(<span class="params">simple_switch_13.SimpleSwitch13</span>):</span></span><br><span class="line">	<span class="comment"># 定期的向交换机发出要求以取得需要统计的数据</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SimpleMonitor13, self).__init__(*args, **kwargs)</span><br><span class="line">        self.datapaths = &#123;&#125;</span><br><span class="line">        self.monitor_thread = hub.spawn(self._monitor)  <span class="comment"># 建立一个绿色线程，运行监控程序</span></span><br><span class="line">        </span><br><span class="line">	<span class="comment"># EventOFPStatureChange的信息类用来监测交换器的连线中断，会被触发在#Dathpath状态改变时</span></span><br><span class="line">	<span class="comment"># 参数二表示 一般状态和连线中断状态</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPStateChange,</span></span></span><br><span class="line"><span class="meta"><span class="params">                [MAIN_DISPATCHER, DEAD_DISPATCHER]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_state_change_handler</span>(<span class="params">self, ev</span>):</span>   </span><br><span class="line">    	<span class="comment"># 通过判断当前状态从监测列表添加或移除当前datapath</span></span><br><span class="line">    	<span class="comment"># 连线中断状态用于确认连线中的交换机可以持续被监控</span></span><br><span class="line">        datapath = ev.datapath</span><br><span class="line">        <span class="comment"># 当datapath的状态变成MAIN_DISPATCHER时，代表交换机已经被注册，并且正处于被监视的状态</span></span><br><span class="line">        <span class="keyword">if</span> ev.state == MAIN_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                self.logger.debug(<span class="string">&#x27;register datapath: %016x&#x27;</span>, datapath.<span class="built_in">id</span>)</span><br><span class="line">                self.datapaths[datapath.<span class="built_in">id</span>] = datapath</span><br><span class="line">        <span class="comment"># 当datapath的状态变成DEAD_DISPATCHER时，代表注册状态已经解除</span></span><br><span class="line">        <span class="keyword">elif</span> ev.state == DEAD_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                self.logger.debug(<span class="string">&#x27;unregister datapath: %016x&#x27;</span>, datapath.<span class="built_in">id</span>)</span><br><span class="line">                <span class="keyword">del</span> self.datapaths[datapath.<span class="built_in">id</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_monitor</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        	<span class="comment"># 不断地注册的向交换机发送要求取得的统计信息</span></span><br><span class="line">            <span class="keyword">for</span> dp <span class="keyword">in</span> self.datapaths.values():</span><br><span class="line">                self._request_stats(dp)</span><br><span class="line">            <span class="comment"># 每隔10s查询一次当前的监视datapath名单中的各个#datapath状况</span></span><br><span class="line">            hub.sleep(<span class="number">10</span>)</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_request_stats</span>(<span class="params">self, datapath</span>):</span></span><br><span class="line">        self.logger.debug(<span class="string">&#x27;send stats request: %016x&#x27;</span>, datapath.<span class="built_in">id</span>)</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">		<span class="comment"># 向指定的datapath发送OFPFlowStatsRequest和OFPStatsResquest消息类实体，即对相关统计信息进行</span></span><br><span class="line">		<span class="comment"># 请求</span></span><br><span class="line">		<span class="comment"># OFPFlowStatsRequest主要用来对交换机的Flow Entry取得统计信息</span></span><br><span class="line">		<span class="comment"># 对于交换即发出的要求可以使用table ID、output port、cookie 值和 match 条件来限定范围，但是以下实现的是取得所有的 Flow Entry。</span></span><br><span class="line">        req = parser.OFPFlowStatsRequest(datapath)</span><br><span class="line">        datapath.send_msg(req)</span><br><span class="line">        </span><br><span class="line">		<span class="comment"># OFPPortStatsRequest 是用来取得关于交换机的端口相关信息以及统计信息。</span></span><br><span class="line">		<span class="comment"># 使用的使用可以指定端口号，以下使用OFPP_ANY，目的是要取得所有的端口统计信息。</span></span><br><span class="line">        req = parser.OFPPortStatsRequest(datapath, <span class="number">0</span>, ofproto.OFPP_ANY)</span><br><span class="line">        datapath.send_msg(req)</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 对FlowStatsReply消息的回复进行事件处理</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPFlowStatsReply, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_flow_stats_reply_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">    	<span class="comment"># body中存放了OFPFlowStats的列表，存储了每一个Flow Entry的统计资料，并作为OFPFlowStatsRequest的回应</span></span><br><span class="line">        body = ev.msg.body  </span><br><span class="line"></span><br><span class="line">        self.logger.info(<span class="string">&#x27;datapath         &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;in-port  eth-dst           &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;out-port packets  bytes&#x27;</span>)</span><br><span class="line">        self.logger.info(<span class="string">&#x27;---------------- &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;-------- ----------------- &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;-------- -------- --------&#x27;</span>)</span><br><span class="line">        <span class="comment"># 对各个优先级非0的流表项按接收端口和目的MAC地址进行排序后遍历</span></span><br><span class="line">        <span class="keyword">for</span> stat <span class="keyword">in</span> <span class="built_in">sorted</span>([flow <span class="keyword">for</span> flow <span class="keyword">in</span> body <span class="keyword">if</span> flow.priority == <span class="number">1</span>],</span><br><span class="line">                           key=<span class="keyword">lambda</span> flow: (flow.match[<span class="string">&#x27;in_port&#x27;</span>],</span><br><span class="line">                                             flow.match[<span class="string">&#x27;eth_dst&#x27;</span>])):</span><br><span class="line">            <span class="comment"># 对交换机的datapath.id，目的MAC地址，输出端口和包以及字节流量进行打印</span></span><br><span class="line">            self.logger.info(<span class="string">&#x27;%016x %8x %17s %8x %8d %8d&#x27;</span>,</span><br><span class="line">                             ev.msg.datapath.<span class="built_in">id</span>,</span><br><span class="line">                             stat.match[<span class="string">&#x27;in_port&#x27;</span>], stat.match[<span class="string">&#x27;eth_dst&#x27;</span>],</span><br><span class="line">                             stat.instructions[<span class="number">0</span>].actions[<span class="number">0</span>].port,</span><br><span class="line">                             stat.packet_count, stat.byte_count)</span><br><span class="line">                             </span><br><span class="line">	<span class="comment"># 对PortStatsReply消息的回复事件进行处理</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPPortStatsReply, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_port_stats_reply_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        body = ev.msg.body</span><br><span class="line"></span><br><span class="line">        self.logger.info(<span class="string">&#x27;datapath         port     &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;rx-pkts  rx-bytes rx-error &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;tx-pkts  tx-bytes tx-error&#x27;</span>)</span><br><span class="line">        self.logger.info(<span class="string">&#x27;---------------- -------- &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;-------- -------- -------- &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;-------- -------- --------&#x27;</span>)</span><br><span class="line">        <span class="comment"># 根据端口号进行排序并遍历</span></span><br><span class="line">        <span class="keyword">for</span> stat <span class="keyword">in</span> <span class="built_in">sorted</span>(body, key=attrgetter(<span class="string">&#x27;port_no&#x27;</span>)):</span><br><span class="line">        	<span class="comment"># 打印交换机id，端口号和接收及发送的包的数量字节数和错误数</span></span><br><span class="line">            self.logger.info(<span class="string">&#x27;%016x %8x %8d %8d %8d %8d %8d %8d&#x27;</span>,</span><br><span class="line">                             ev.msg.datapath.<span class="built_in">id</span>, stat.port_no,</span><br><span class="line">                             stat.rx_packets, stat.rx_bytes, stat.rx_errors,</span><br><span class="line">                             stat.tx_packets, stat.tx_bytes, stat.tx_errors)</span><br></pre></td></tr></table></figure>
<p>在<a target="_blank" rel="noopener" href="https://osrg.github.io/ryu-book/zh_tw/html/traffic_monitor.html">Ryubook</a>中给出了OFPFlowStats的JSON格式的全部信息，下面给出OFPPortStats的JSON数据信息：<br><img src="https://img-blog.csdnimg.cn/20191110124754396.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA5NDU4OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="2-2-3-ryu-app-simple-switch-rest-13-py"><a href="#2-2-3-ryu-app-simple-switch-rest-13-py" class="headerlink" title="2.2.3 /ryu/app/simple_switch_rest_13.py"></a>2.2.3 /ryu/app/simple_switch_rest_13.py</h3><p>关于ofctl_rest.py的用法参考<a target="_blank" rel="noopener" href="https://www.sdnlab.com/11552.html">链接</a></p>
<p>RYU本身提供了一个类似WSGI的web服务器功能。借助这个功能，我们可以创建一个REST API。基于创建的REST API，可以快速的将RYU系统与其他系统或者是浏览器相连接。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh/%E8%A1%A8%E7%8E%B0%E5%B1%82%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2">REST</a>：表征性状态传输（英文：Representational State Transfer，简称REST）是Roy Fielding博士在2000年他的博士论文中提出来的一种软件架构风格。REST架构风格中，资源是通过URI来描述的。对资源的操作采用了HTTP的GET，POST，PUT和DELETE方法相对应。资源的表现形式可以是json或xml。REST的架构是Client-Server架构，同时链接是无状态的。所以要求在传输的过程中需要包含状态信息。</p>
<p>代码解析：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ryu.app <span class="keyword">import</span> simple_switch_13</span><br><span class="line"><span class="keyword">from</span> ryu.controller <span class="keyword">import</span> ofp_event</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> CONFIG_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> set_ev_cls</span><br><span class="line"><span class="keyword">from</span> ryu.app.wsgi <span class="keyword">import</span> ControllerBase</span><br><span class="line"><span class="keyword">from</span> ryu.app.wsgi <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> ryu.app.wsgi <span class="keyword">import</span> route</span><br><span class="line"><span class="keyword">from</span> ryu.app.wsgi <span class="keyword">import</span> WSGIApplication</span><br><span class="line"><span class="keyword">from</span> ryu.lib <span class="keyword">import</span> dpid <span class="keyword">as</span> dpid_lib</span><br><span class="line"></span><br><span class="line">simple_switch_instance_name = <span class="string">&#x27;simple_switch_api_app&#x27;</span></span><br><span class="line"><span class="comment"># 指定url为如下方式，其中，&#123;dpid&#125; 的部分必須與 ryu/lib/dpid.py</span></span><br><span class="line">url = <span class="string">&#x27;/simpleswitch/mactable/&#123;dpid&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSwitchRest13</span>(<span class="params">simple_switch_13.SimpleSwitch13</span>):</span></span><br><span class="line">	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		更新交换机的MAC地址表</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span></span><br><span class="line">    _CONTEXTS = &#123;<span class="string">&#x27;wsgi&#x27;</span>: WSGIApplication&#125;  <span class="comment"># 用来建立Ryu中WSGI网页服务器所对应的类别，因此可通过wsgi Key来取得网页服务器的实体</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SimpleSwitchRest13, self).__init__(*args, **kwargs)</span><br><span class="line">        self.switches = &#123;&#125;</span><br><span class="line">        wsgi = kwargs[<span class="string">&#x27;wsgi&#x27;</span>]  <span class="comment"># 通过上一步设置的_CONTEXTS成员变量，可以通过kwargs进行实例化一个WSGIApplication。</span></span><br><span class="line">        wsgi.register(SimpleSwitchController,</span><br><span class="line">                      &#123;simple_switch_instance_name: self&#125;)  <span class="comment"># 使用register方法注册该服务到controller类上。</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 重写父类的switch_features_handler函数</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">switch_features_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SimpleSwitchRest13, self).switch_features_handler(ev)</span><br><span class="line">        datapath = ev.msg.datapath</span><br><span class="line">        self.switches[datapath.<span class="built_in">id</span>] = datapath  <span class="comment"># 存储datapath到switches</span></span><br><span class="line">        self.mac_to_port.setdefault(datapath.<span class="built_in">id</span>, &#123;&#125;)  <span class="comment"># 初始化MAC地址表</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_mac_to_port</span>(<span class="params">self, dpid, entry</span>):</span></span><br><span class="line">    	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    		该方法将MAC地址和端口注册到指定的交换机。该方法主要被REST API的PUT方法所调用。</span></span><br><span class="line"><span class="string">    	&quot;&quot;&quot;</span></span><br><span class="line">    	<span class="comment"># 获取MAC table</span></span><br><span class="line">        mac_table = self.mac_to_port.setdefault(dpid, &#123;&#125;)</span><br><span class="line">         <span class="comment"># 获取datapath,如果为None，证明没有该交换机</span></span><br><span class="line">        datapath = self.switches.get(dpid)</span><br><span class="line"></span><br><span class="line">        entry_port = entry[<span class="string">&#x27;port&#x27;</span>]</span><br><span class="line">        entry_mac = entry[<span class="string">&#x27;mac&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> datapath <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            parser = datapath.ofproto_parser</span><br><span class="line">            <span class="comment"># # 如果entry_port不在mac_table中</span></span><br><span class="line">            <span class="keyword">if</span> entry_port <span class="keyword">not</span> <span class="keyword">in</span> mac_table.values():</span><br><span class="line">				 <span class="comment"># 下发流表</span></span><br><span class="line">                <span class="keyword">for</span> mac, port <span class="keyword">in</span> mac_table.items():</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># from known device to new device</span></span><br><span class="line">                    actions = [parser.OFPActionOutput(entry_port)]</span><br><span class="line">                    match = parser.OFPMatch(in_port=port, eth_dst=entry_mac)</span><br><span class="line">                    self.add_flow(datapath, <span class="number">1</span>, match, actions)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># from new device to known device</span></span><br><span class="line">                    actions = [parser.OFPActionOutput(port)]</span><br><span class="line">                    match = parser.OFPMatch(in_port=entry_port, eth_dst=mac)</span><br><span class="line">                    self.add_flow(datapath, <span class="number">1</span>, match, actions)</span><br><span class="line">				<span class="comment"># 添加entry_mac, entry_port到mac_table</span></span><br><span class="line">                mac_table.update(&#123;entry_mac: entry_port&#125;)</span><br><span class="line">        <span class="keyword">return</span> mac_table</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSwitchController</span>(<span class="params">ControllerBase</span>):</span></span><br><span class="line">	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		定义收到HTTP请求时所需要回应的操作</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, req, link, data, **config</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SimpleSwitchController, self).__init__(req, link, data, **config)</span><br><span class="line">        self.simple_switch_app = data[simple_switch_instance_name]</span><br><span class="line">	<span class="comment"># 借助route装饰器关联方法和URL, </span></span><br><span class="line">	<span class="comment"># 第一个参数：任何自定义名称; </span></span><br><span class="line">	<span class="comment"># 第二个参数：指明URL;</span></span><br><span class="line">	<span class="comment"># 第三个参数：指定http方法;</span></span><br><span class="line">	<span class="comment"># 第四个参数：指明指定位置的格式，URL(/simpleswitch/mactable/&#123;dpid&#125; 匹配DPID_PATTERN的描述</span></span><br><span class="line">	<span class="comment"># 当使用GET方式访问到该REST API接口时，调用list_mac_table函数！！</span></span><br><span class="line"><span class="meta">    @route(<span class="params"><span class="string">&#x27;simpleswitch&#x27;</span>, url, methods=[<span class="string">&#x27;GET&#x27;</span>],</span></span></span><br><span class="line"><span class="meta"><span class="params">           requirements=&#123;<span class="string">&#x27;dpid&#x27;</span>: dpid_lib.DPID_PATTERN&#125;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list_mac_table</span>(<span class="params">self, req, **kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">        simple_switch = self.simple_switch_app</span><br><span class="line">        <span class="comment"># 获取&#123;dpid&#125;</span></span><br><span class="line">        dpid = dpid_lib.str_to_dpid(kwargs[<span class="string">&#x27;dpid&#x27;</span>])</span><br><span class="line">		<span class="comment"># 如果没有dpid,返回404</span></span><br><span class="line">        <span class="keyword">if</span> dpid <span class="keyword">not</span> <span class="keyword">in</span> simple_switch.mac_to_port:</span><br><span class="line">            <span class="keyword">return</span> Response(status=<span class="number">404</span>)</span><br><span class="line">		<span class="comment"># 获取mac_table</span></span><br><span class="line">        mac_table = simple_switch.mac_to_port.get(dpid, &#123;&#125;)</span><br><span class="line">        body = json.dumps(mac_table)</span><br><span class="line">        <span class="keyword">return</span> Response(content_type=<span class="string">&#x27;application/json&#x27;</span>, body=body)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 使用PUT方式设置mac_table</span></span><br><span class="line"><span class="meta">    @route(<span class="params"><span class="string">&#x27;simpleswitch&#x27;</span>, url, methods=[<span class="string">&#x27;PUT&#x27;</span>],</span></span></span><br><span class="line"><span class="meta"><span class="params">           requirements=&#123;<span class="string">&#x27;dpid&#x27;</span>: dpid_lib.DPID_PATTERN&#125;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put_mac_table</span>(<span class="params">self, req, **kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">        simple_switch = self.simple_switch_app</span><br><span class="line">        dpid = dpid_lib.str_to_dpid(kwargs[<span class="string">&#x27;dpid&#x27;</span>])</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            new_entry = req.json <span class="keyword">if</span> req.body <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">raise</span> Response(status=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dpid <span class="keyword">not</span> <span class="keyword">in</span> simple_switch.mac_to_port:</span><br><span class="line">            <span class="keyword">return</span> Response(status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            mac_table = simple_switch.set_mac_to_port(dpid, new_entry)</span><br><span class="line">            body = json.dumps(mac_table)</span><br><span class="line">            <span class="keyword">return</span> Response(content_type=<span class="string">&#x27;application/json&#x27;</span>, body=body)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> Response(status=<span class="number">500</span>)</span><br></pre></td></tr></table></figure>


<h3 id="2-2-4-ryu-app-gui-topology-gui-topology-py实现功能为：定期检查网络状态"><a href="#2-2-4-ryu-app-gui-topology-gui-topology-py实现功能为：定期检查网络状态" class="headerlink" title="2.2.4 ryu/app/gui_topology/gui_topology.py实现功能为：定期检查网络状态"></a>2.2.4 ryu/app/gui_topology/gui_topology.py实现功能为：定期检查网络状态</h3><p>ryu4.3版本和ryu3.14版本打开gui方式有所不同，本人安装版本为4.3。进入gui_topology文件夹进行，并运行如下命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ryu-manager --observe-links gui_topology.py</span><br></pre></td></tr></table></figure>
<p>用mininet模拟了一个深度为3的树状网络拓扑，并连接到ryu，命令如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mn --controller remote --mac --topo tree,<span class="number">2</span>,<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>连接成功后，访问<a href="http://localhost:8080（我的ryu和mininet均运行在本机），即可看到如下界面：">http://localhost:8080（我的ryu和mininet均运行在本机），即可看到如下界面：</a><br><img src="https://img-blog.csdnimg.cn/20191107214500356.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA5NDU4OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>物理实验，打开一个openflow交换机，访问<a href="http://localhost:8080，看到界面如下：">http://localhost:8080，看到界面如下：</a><br><img src="https://img-blog.csdnimg.cn/20191107214649427.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA5NDU4OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="2-2-5-ryu-app-simple-switch-lacp-13-py实现的功能为：链路聚合"><a href="#2-2-5-ryu-app-simple-switch-lacp-13-py实现的功能为：链路聚合" class="headerlink" title="2.2.5 /ryu/app/simple_switch_lacp_13.py实现的功能为：链路聚合"></a>2.2.5 /ryu/app/simple_switch_lacp_13.py实现的功能为：链路聚合</h3><p>网络聚合（ Link Aggregation ）是由 IEEE802.1AX-2008 所制定的，多条实体线路合并为一条逻辑线路（即，多个物理端口汇聚在一起，形成一个逻辑端口），以实现出/入流量吞吐量在各成员端口的负荷分担，交换机根据用户配置的端口负荷分担策略决定网络封包从哪个成员端口发送到对端的交换机。当交换机检测到其中一个成员端口的链路发生故障时，就停止在此端口上发送封包，并根据负荷分担策略在剩下的链路中重新计算报文的发送端口，故障端口回复再次担任收发端口。</p>
<p>因此链路聚合的实现可以让网络中特定的装置间通信速度提升、同时确保支援能力、提升容错的功能。可通过<strong>LACP</strong>（ Link Aggregation Control Protocol ）协议动态方法实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ryu.base <span class="keyword">import</span> app_manager</span><br><span class="line"><span class="keyword">from</span> ryu.controller <span class="keyword">import</span> ofp_event</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> CONFIG_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> MAIN_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> set_ev_cls</span><br><span class="line"><span class="keyword">from</span> ryu.ofproto <span class="keyword">import</span> ofproto_v1_3</span><br><span class="line"><span class="keyword">from</span> ryu.lib <span class="keyword">import</span> lacplib</span><br><span class="line"><span class="keyword">from</span> ryu.lib.dpid <span class="keyword">import</span> str_to_dpid</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> packet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ethernet</span><br><span class="line"><span class="keyword">from</span> ryu.app <span class="keyword">import</span> simple_switch_13</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSwitchLacp13</span>(<span class="params">simple_switch_13.SimpleSwitch13</span>):</span></span><br><span class="line">    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]</span><br><span class="line">    _CONTEXTS = &#123;<span class="string">&#x27;lacplib&#x27;</span>: lacplib.LacpLib&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SimpleSwitchLacp13, self).__init__(*args, **kwargs)</span><br><span class="line">        self.mac_to_port = &#123;&#125;</span><br><span class="line">        <span class="comment"># 通过成员变量_CONTEXTS，可以通过kwargs进行实例化一个lacplib的应用程序。</span></span><br><span class="line">        self._lacp = kwargs[<span class="string">&#x27;lacplib&#x27;</span>]</span><br><span class="line">        <span class="comment"># 通过LACP的add()方法来完成初始化设置，</span></span><br><span class="line">        <span class="comment"># 以下代码的初始化设置为：</span></span><br><span class="line">        <span class="comment"># datapath ID为0000000000000001的OpenFlow交换机的端口1和端口2整合为一个网络聚合群组</span></span><br><span class="line">        self._lacp.add(</span><br><span class="line">            dpid=str_to_dpid(<span class="string">&#x27;0000000000000001&#x27;</span>), ports=[<span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">del_flow</span>(<span class="params">self, datapath, match</span>):</span></span><br><span class="line">    	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    		当端口有效/无效状态变更时，被逻辑链路所使用的实体链路会因为数据包的通过而改变状态。</span></span><br><span class="line"><span class="string">    		因此，需要删除已经被记录的流表项</span></span><br><span class="line"><span class="string">    	&quot;&quot;&quot;</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line"></span><br><span class="line">        mod = parser.OFPFlowMod(datapath=datapath,</span><br><span class="line">                                command=ofproto.OFPFC_DELETE,</span><br><span class="line">                                out_port=ofproto.OFPP_ANY,</span><br><span class="line">                                out_group=ofproto.OFPG_ANY,</span><br><span class="line">                                match=match)</span><br><span class="line">        datapath.send_msg(mod)</span><br><span class="line">	</span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">lacplib.EventPacketIn, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_packet_in_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">    	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    		需要由lacplib.EventPacketIn来装饰自定义的Packet-In函数</span></span><br><span class="line"><span class="string">    	&quot;&quot;&quot;</span></span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        in_port = msg.match[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        pkt = packet.Packet(msg.data)</span><br><span class="line">        eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        dst = eth.dst</span><br><span class="line">        src = eth.src</span><br><span class="line"></span><br><span class="line">        dpid = datapath.<span class="built_in">id</span></span><br><span class="line">        self.mac_to_port.setdefault(dpid, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">        self.logger.info(<span class="string">&quot;packet in %s %s %s %s&quot;</span>, dpid, src, dst, in_port)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># learn a mac address to avoid FLOOD next time.</span></span><br><span class="line">        self.mac_to_port[dpid][src] = in_port</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dst <span class="keyword">in</span> self.mac_to_port[dpid]:</span><br><span class="line">            out_port = self.mac_to_port[dpid][dst]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            out_port = ofproto.OFPP_FLOOD</span><br><span class="line"></span><br><span class="line">        actions = [parser.OFPActionOutput(out_port)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># install a flow to avoid packet_in next time</span></span><br><span class="line">        <span class="keyword">if</span> out_port != ofproto.OFPP_FLOOD:</span><br><span class="line">            match = parser.OFPMatch(in_port=in_port, eth_dst=dst)</span><br><span class="line">            self.add_flow(datapath, <span class="number">1</span>, match, actions)</span><br><span class="line"></span><br><span class="line">        data = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:</span><br><span class="line">            data = msg.data</span><br><span class="line"></span><br><span class="line">        out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,</span><br><span class="line">                                  in_port=in_port, actions=actions, data=data)</span><br><span class="line">        datapath.send_msg(out)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">lacplib.EventSlaveStateChanged, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_slave_state_changed_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">    	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    		当端口的状态变更为有效或者无效时，需要通过EventSlaveStateChanged事件来进行处理</span></span><br><span class="line"><span class="string">    	&quot;&quot;&quot;</span></span><br><span class="line">        datapath = ev.datapath</span><br><span class="line">        dpid = datapath.<span class="built_in">id</span></span><br><span class="line">        port_no = ev.port</span><br><span class="line">        enabled = ev.enabled</span><br><span class="line">        self.logger.info(<span class="string">&quot;slave state changed port: %d enabled: %s&quot;</span>,</span><br><span class="line">                         port_no, enabled)</span><br><span class="line">        <span class="keyword">if</span> dpid <span class="keyword">in</span> self.mac_to_port:</span><br><span class="line">            <span class="keyword">for</span> mac <span class="keyword">in</span> self.mac_to_port[dpid]:</span><br><span class="line">                match = datapath.ofproto_parser.OFPMatch(eth_dst=mac)</span><br><span class="line">                self.del_flow(datapath, match)</span><br><span class="line">            <span class="keyword">del</span> self.mac_to_port[dpid]</span><br><span class="line">        self.mac_to_port.setdefault(dpid, &#123;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-2-6-ryu-app-simple-switch-stp-13-py实现功能为：生成树协议"><a href="#2-2-6-ryu-app-simple-switch-stp-13-py实现功能为：生成树协议" class="headerlink" title="2.2.6 /ryu/app/simple_switch_stp_13.py实现功能为：生成树协议"></a>2.2.6 /ryu/app/simple_switch_stp_13.py实现功能为：生成树协议</h3><p>生成树是为了防止网络的拓扑中出现环路而产生广播风暴、占用交换机大量资源的技术。生成树有许多种类，例如STP、RSTP、PVST+、MSTP等不同的种类。详细介绍参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34104227/article/details/81982689">博客</a>。</p>
<p>下边将介绍Ryu中的<strong>STP</strong>协议的实现</p>
<p><strong>STP</strong>可以消除网络中的环路。其基本理论依据是根据网络拓扑构建（生成）无回路的连通图（就是树），从而保证数据传输路径的唯一性，避免出现环路导致报文流量的增加和循环。STP是工作在OSI第二层（Data Link Layer）的协议，通过在交换机之间传递特殊的消息并进行分布式的计算，来决定在一个有环路的网络中，某台交换机的某个端口应该被阻塞，用这种方法来避免掉环路。</p>
<p><strong>STP作用：</strong> 消除环路：通过阻断冗余链路来消除网络中可能存在的环路；链路备份：当活动路径发生故障时，激活备份链路，及时恢复网络连通性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ryu.base <span class="keyword">import</span> app_manager</span><br><span class="line"><span class="keyword">from</span> ryu.controller <span class="keyword">import</span> ofp_event</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> CONFIG_DISPATCHER, MAIN_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> set_ev_cls</span><br><span class="line"><span class="keyword">from</span> ryu.ofproto <span class="keyword">import</span> ofproto_v1_3</span><br><span class="line"><span class="keyword">from</span> ryu.lib <span class="keyword">import</span> dpid <span class="keyword">as</span> dpid_lib</span><br><span class="line"><span class="keyword">from</span> ryu.lib <span class="keyword">import</span> stplib</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> packet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ethernet</span><br><span class="line"><span class="keyword">from</span> ryu.app <span class="keyword">import</span> simple_switch_13</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSwitch13</span>(<span class="params">simple_switch_13.SimpleSwitch13</span>):</span></span><br><span class="line">    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]</span><br><span class="line">    _CONTEXTS = &#123;<span class="string">&#x27;stplib&#x27;</span>: stplib.Stp&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SimpleSwitch13, self).__init__(*args, **kwargs)</span><br><span class="line">        self.mac_to_port = &#123;&#125;</span><br><span class="line">        self.stp = kwargs[<span class="string">&#x27;stplib&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Sample of stplib config.</span></span><br><span class="line">        <span class="comment">#  please refer to stplib.Stp.set_config() for details.</span></span><br><span class="line">        config = &#123;dpid_lib.str_to_dpid(<span class="string">&#x27;0000000000000001&#x27;</span>):</span><br><span class="line">                  &#123;<span class="string">&#x27;bridge&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">0x8000</span>&#125;&#125;,</span><br><span class="line">                  dpid_lib.str_to_dpid(<span class="string">&#x27;0000000000000002&#x27;</span>):</span><br><span class="line">                  &#123;<span class="string">&#x27;bridge&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">0x9000</span>&#125;&#125;,</span><br><span class="line">                  dpid_lib.str_to_dpid(<span class="string">&#x27;0000000000000003&#x27;</span>):</span><br><span class="line">                  &#123;<span class="string">&#x27;bridge&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">0xa000</span>&#125;&#125;&#125;</span><br><span class="line">        self.stp.set_config(config)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_flow</span>(<span class="params">self, datapath</span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> dst <span class="keyword">in</span> self.mac_to_port[datapath.<span class="built_in">id</span>].keys():</span><br><span class="line">            match = parser.OFPMatch(eth_dst=dst)</span><br><span class="line">            mod = parser.OFPFlowMod(</span><br><span class="line">                datapath, command=ofproto.OFPFC_DELETE,</span><br><span class="line">                out_port=ofproto.OFPP_ANY, out_group=ofproto.OFPG_ANY,</span><br><span class="line">                priority=<span class="number">1</span>, match=match)</span><br><span class="line">            datapath.send_msg(mod)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">stplib.EventPacketIn, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_packet_in_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        in_port = msg.match[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        pkt = packet.Packet(msg.data)</span><br><span class="line">        eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        dst = eth.dst</span><br><span class="line">        src = eth.src</span><br><span class="line"></span><br><span class="line">        dpid = datapath.<span class="built_in">id</span></span><br><span class="line">        self.mac_to_port.setdefault(dpid, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">        self.logger.info(<span class="string">&quot;packet in %s %s %s %s&quot;</span>, dpid, src, dst, in_port)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># learn a mac address to avoid FLOOD next time.</span></span><br><span class="line">        self.mac_to_port[dpid][src] = in_port</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dst <span class="keyword">in</span> self.mac_to_port[dpid]:</span><br><span class="line">            out_port = self.mac_to_port[dpid][dst]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            out_port = ofproto.OFPP_FLOOD</span><br><span class="line"></span><br><span class="line">        actions = [parser.OFPActionOutput(out_port)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># install a flow to avoid packet_in next time</span></span><br><span class="line">        <span class="keyword">if</span> out_port != ofproto.OFPP_FLOOD:</span><br><span class="line">            match = parser.OFPMatch(in_port=in_port, eth_dst=dst)</span><br><span class="line">            self.add_flow(datapath, <span class="number">1</span>, match, actions)</span><br><span class="line"></span><br><span class="line">        data = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:</span><br><span class="line">            data = msg.data</span><br><span class="line"></span><br><span class="line">        out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,</span><br><span class="line">                                  in_port=in_port, actions=actions, data=data)</span><br><span class="line">        datapath.send_msg(out)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">stplib.EventTopologyChange, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_topology_change_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        dp = ev.dp</span><br><span class="line">        dpid_str = dpid_lib.dpid_to_str(dp.<span class="built_in">id</span>)</span><br><span class="line">        msg = <span class="string">&#x27;Receive topology change event. Flush MAC table.&#x27;</span></span><br><span class="line">        self.logger.debug(<span class="string">&quot;[dpid=%s] %s&quot;</span>, dpid_str, msg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dp.<span class="built_in">id</span> <span class="keyword">in</span> self.mac_to_port:</span><br><span class="line">            self.delete_flow(dp)</span><br><span class="line">            <span class="keyword">del</span> self.mac_to_port[dp.<span class="built_in">id</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">stplib.EventPortStateChange, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_port_state_change_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        dpid_str = dpid_lib.dpid_to_str(ev.dp.<span class="built_in">id</span>)</span><br><span class="line">        of_state = &#123;stplib.PORT_STATE_DISABLE: <span class="string">&#x27;DISABLE&#x27;</span>,</span><br><span class="line">                    stplib.PORT_STATE_BLOCK: <span class="string">&#x27;BLOCK&#x27;</span>,</span><br><span class="line">                    stplib.PORT_STATE_LISTEN: <span class="string">&#x27;LISTEN&#x27;</span>,</span><br><span class="line">                    stplib.PORT_STATE_LEARN: <span class="string">&#x27;LEARN&#x27;</span>,</span><br><span class="line">                    stplib.PORT_STATE_FORWARD: <span class="string">&#x27;FORWARD&#x27;</span>&#125;</span><br><span class="line">        self.logger.debug(<span class="string">&quot;[dpid=%s][port=%d] state=%s&quot;</span>,</span><br><span class="line">                          dpid_str, ev.port_no, of_state[ev.port_state])</span><br></pre></td></tr></table></figure>

<h1 id="3-RYU的运行"><a href="#3-RYU的运行" class="headerlink" title="3 RYU的运行"></a>3 RYU的运行</h1><h2 id="3-1-RYU基本操作"><a href="#3-1-RYU基本操作" class="headerlink" title="3.1 RYU基本操作"></a>3.1 RYU基本操作</h2><p><strong>a、RYU使用命令</strong></p>
<p>使用命令格式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ryu-manager &lt;yourapp&gt;</span><br></pre></td></tr></table></figure>
<p>如，进入ryu/app目录，运行simple_switch_13.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ryu-manager simple_switch_13.py</span><br></pre></td></tr></table></figure>

<p><strong>b、RYU启动参数</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ryu-manager 启动ryu, 如果不加任何参数，则默认启动ofphandler模块。</span><br><span class="line">ryu-manager –h 查看帮助信息</span><br><span class="line">--verbose 打印详细debug信息</span><br><span class="line">--version 显示程序的版本号并退出</span><br><span class="line">--observe-links 自动下发LLDP，用于拓扑发现</span><br><span class="line">--ofp-tcp-listen-port  修改ryu的openflow tcp监听端口</span><br><span class="line">…</span><br></pre></td></tr></table></figure>
<p>说明：若在启动RYU时使用了–observe-links参数，则RYU会收到非常大量的包含LLDP协议报文的PacketIn消息如果不对这一PacketIn消息进行特殊处理的话，很容易导致Ryu奔溃，无法正常工作！！！所以，为了避免这一问题，当你计划使用–observe-links启动Ryu时，在你处理PacketIn消息的函数开头，建议包含如下代码，即可解决问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> eth.ethertype == ether_types.ETH_TYPE_LLDP:</span><br><span class="line">	<span class="comment"># ignore lldp packet</span></span><br><span class="line">	<span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-RYU运行流程"><a href="#3-2-RYU运行流程" class="headerlink" title="3.2 RYU运行流程"></a>3.2 RYU运行流程</h2><p><a target="_blank" rel="noopener" href="https://github.com/osrg/ryu/blob/master/ryu/cmd/manager.py">RYU</a>的main函数在ryu/cmd/maneger.py文件中，main函数主要内容如下代码。</p>
<ul>
<li>在main函数中，首先从CONF文件中读取出app list。如果ryu-manager命令中不带任何参数，则默认应用为<strong>ofp_handler</strong>应用</li>
</ul>
<p> <strong>NT：</strong> ofp_handler应用主要用于处理OpenFlow消息，完成了基本的消息处理，如hello_handler，用于处理hello报文</p>
<ul>
<li>紧接着实例化一个AppManager对象，调用load_apps函数将应用加载。调用create_contexts函数创建对应的contexts</li>
<li>然后调用instantiate_apps函数将app_list和context中的app均实例化。启动wsgi架构，提供web应用</li>
<li>最后将所有的应用作为任务，作为coroutine的task去执行，joinall使得程序必须等待所有的task都执行完成才可以退出程序。最后调用close函数，关闭程序，释放资源</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">args=<span class="literal">None</span>, prog=<span class="literal">None</span></span>):</span></span><br><span class="line">    _parse_user_flags()</span><br><span class="line">    <span class="comment"># 根据配置项的注册，读取配置文件/usr/loca/etc/ryu/ryu.conf的配置</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        CONF(args=args, prog=prog,</span><br><span class="line">             project=<span class="string">&#x27;ryu&#x27;</span>, version=<span class="string">&#x27;ryu-manager %s&#x27;</span> % version,</span><br><span class="line">             default_config_files=[<span class="string">&#x27;/usr/local/etc/ryu/ryu.conf&#x27;</span>])</span><br><span class="line">    <span class="keyword">except</span> cfg.ConfigFilesNotFoundError:</span><br><span class="line">        CONF(args=args, prog=prog,</span><br><span class="line">             project=<span class="string">&#x27;ryu&#x27;</span>, version=<span class="string">&#x27;ryu-manager %s&#x27;</span> % version)</span><br><span class="line"></span><br><span class="line">    log.init_log()  <span class="comment"># 初始化打印log</span></span><br><span class="line">    logger = logging.getLogger(__name__)</span><br><span class="line">	<span class="comment"># 根据配置文件的配置执行 log、pidfile</span></span><br><span class="line">    <span class="keyword">if</span> CONF.enable_debugger:</span><br><span class="line">        msg = <span class="string">&#x27;debugging is available (--enable-debugger option is turned on)&#x27;</span></span><br><span class="line">        logger.info(msg)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        hub.patch(thread=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> CONF.pid_file:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(CONF.pid_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> pid_file:</span><br><span class="line">            pid_file.write(<span class="built_in">str</span>(os.getpid()))</span><br><span class="line">	<span class="comment"># 启动applist中的应用，若applist为空，则启动ofp_handler应用</span></span><br><span class="line">    app_lists = CONF.app_lists + CONF.app</span><br><span class="line">    <span class="comment"># keep old behavior, run ofp if no application is specified.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> app_lists:</span><br><span class="line">        app_lists = [<span class="string">&#x27;ryu.controller.ofp_handler&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    app_mgr = AppManager.get_instance()  <span class="comment"># 在AppManager类中获取实例</span></span><br><span class="line">    app_mgr.load_apps(app_lists)  <span class="comment"># 加载App</span></span><br><span class="line">    contexts = app_mgr.create_contexts()  <span class="comment"># 创建运行环境，&quot;dpset&quot;/&quot;wsgi&quot;</span></span><br><span class="line">    services = []</span><br><span class="line">    services.extend(app_mgr.instantiate_apps(**contexts))</span><br><span class="line">	<span class="comment"># 启动App线程，App实例化</span></span><br><span class="line">    <span class="comment"># ryu.controller.dpset.DPSet / rest_firewall.RestFirewallAPI / ryu.controller.ofp_handler.OFPHandler</span></span><br><span class="line">    webapp = wsgi.start_service(app_mgr)  <span class="comment"># webapp启动</span></span><br><span class="line">    <span class="keyword">if</span> webapp:</span><br><span class="line">        thr = hub.spawn(webapp)</span><br><span class="line">        services.append(thr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        hub.joinall(services)  <span class="comment"># 调用t.wait(),执行等待，wait()方法使当前线程暂停执行并释放对象锁标志</span></span><br><span class="line">    						   <span class="comment"># 循环join,直到有异常或者外部中断推迟</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        logger.debug(<span class="string">&quot;Keyboard Interrupt received. &quot;</span></span><br><span class="line">                     <span class="string">&quot;Closing RYU application manager...&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        app_mgr.close()</span><br></pre></td></tr></table></figure>
<p><strong>NT：</strong> Datapath类在RYU中极为重要，位于ryu/controller/controller.py中，每当一个datapath实体与控制器建立连接时，就会实例化一个Datapath的对象。Datapath为OVS内核模块，类似网桥，负责执行数据交换，也就是把从接受端口收到的数据包在流表中进行匹配，并执行匹配到的动作，一个Datapath关联一个flow table，一个flow table包含多个条目。</p>
<h2 id="3-3-RYU应用开发"><a href="#3-3-RYU应用开发" class="headerlink" title="3.3 RYU应用开发"></a>3.3 RYU应用开发</h2><p>ryu/base/app_manager.py文件中，实现了两个类RyuApp和AppManager。</p>
<ul>
<li>RyuApp类是RYU封装好的APP基类，为应用开发提供基本的模板，用户只需要继承该类，即可开发应用，而注册对应的observer和handler都使用@derocator的形式，使得开发非常的简单高效。</li>
<li>AppManager类用于Application的管理，加载应用，运行应用，消息路由等功能，是RYU应用的调度中心。<h3 id="3-3-1-Event-Handle"><a href="#3-3-1-Event-Handle" class="headerlink" title="3.3.1 Event Handle"></a>3.3.1 Event Handle</h3>在实现RYU各项功能时，需要用到事件管理（Event Handle）。因为对于RYU来说，接收到的任何一个OpenFlow消息都会产生一个相对应的事件。而在<strong>RYU的应用程序开发时，必须实现事件管理以处理相对应发生的事件。</strong> </li>
</ul>
<p><strong>Event Handle</strong>是一个拥有事件物件（Event Object）作为参数，并且使用”ryu.controller.handler.set_ev_cls”装饰的函数。</p>
<p><strong>set_ev_cls</strong> 参数包括：指定事件类别得以接受消息、 交换机状态，其中</p>
<ul>
<li><strong>事件类别</strong>：名称命名规则ryu.controller.<strong>ofp_event</strong>.EventOFP + &lt;OpenFlow消息名称&gt;，例如在 Packet-In 消息的状态下的事件名称为EventOFPPacketIn。<strong>OpenFlow消息</strong>在ryu\ofproto\ofproto_v1_X_parser中可以查看。详细内容可参考RYU的<a target="_blank" rel="noopener" href="https://ryu.readthedocs.io/en/latest/">API资料</a>，或者这篇<a target="_blank" rel="noopener" href="https://www.cnblogs.com/NinWoo/p/9398310.html">博客</a></li>
<li><strong>交换机状态</strong>：对于交换机状态来说，可指定以下其一<br>ryu.controller.handler.HANDSHAKE_DISPATCHER    交换HELLO 消息<br>ryu.controller.handler.CONFIG_DISPATCHER    接收 SwitchFeatures消息<br>ryu.controller.handler.MAIN_DISPATCHER    一般状态<br>ryu.controller.handler.DEAD_DISPATCHER    连线中断</li>
</ul>
<p><strong>因此，处理事件函数的标准模板如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@set_ev_cls(<span class="params">ofp_event.Event, DISPATCHER(<span class="params">s</span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">your_function</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>简单说，@set_ev_cls(ofp_event.Event, DISPATCHER(s))的含义就是，当接收DISPATCHER(s)情况的<strong>Event</strong>事件进行your_function处理。</p>
<h3 id="3-3-2-源代码其他细节说明"><a href="#3-3-2-源代码其他细节说明" class="headerlink" title="3.3.2 源代码其他细节说明"></a>3.3.2 源代码其他细节说明</h3><p>OpenFlow协议中的细节：Match、Instructions 和 Action 在 OpenFlow 协议中的细节参考<a target="_blank" rel="noopener" href="https://osrg.github.io/ryu-book/zh_tw/html/openflow_protocol.html">链接</a></p>
<p>ofproto函数库的使用：ofproto函数库是用来产生和解析OpenFlow消息的函数库。可参考<a target="_blank" rel="noopener" href="https://osrg.github.io/ryu-book/zh_tw/html/ofproto_lib.html">链接</a></p>
<p>数据包处理协议：Ryu中提供了许多解析和包装数据包的协议，比如ARP、BGP、IPV4等，可参考<a target="_blank" rel="noopener" href="https://osrg.github.io/ryu-book/zh_tw/html/packet_lib.html">链接</a></p>
<p>of-config函数库：of-config是用来管理OpenFlow交换机的一个通讯协议。of-config通讯协议被定义在 NETCONF（RFC 6241）标准中，可以对逻辑交换机的Port和Queue进行设定，参考<a target="_blank" rel="noopener" href="https://osrg.github.io/ryu-book/zh_tw/html/of_config.html">链接</a></p>
<h1 id="4-常见问题"><a href="#4-常见问题" class="headerlink" title="4 常见问题"></a>4 常见问题</h1><h2 id="4-1-ryu-manager运行报错"><a href="#4-1-ryu-manager运行报错" class="headerlink" title="4.1 ryu-manager运行报错"></a>4.1 ryu-manager运行报错</h2><p>当ryu-manager被多次执行，或者ryu的监听端口6633被占用时，会运行报错。ryu控制器默认使用6633端口，因此应该首先查看哪个进程占用了这个端口，执行命令sudo lsof -i :6633。若该端口被占用，有如下两种方案解决办法：</p>
<ul>
<li>直接将占用进程kill掉：sudo kill -9 pid（进程号）</li>
<li>将ryu的端口号设为其他不被占用的端口，如5555端口：ryu-manager –ofp-tcp-listen-port 5555 -verbose</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>本文部分内容参考：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zxqstrong/p/4789105.html">https://www.cnblogs.com/zxqstrong/p/4789105.html</a><br><a target="_blank" rel="noopener" href="https://osrg.github.io/ryu-book/zh_tw/html/index.html">https://osrg.github.io/ryu-book/zh_tw/html/index.html</a></p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.li2ui2.xyz/2020/11/20/SDN-%E4%B8%89-RYU%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/" title="SDN(三) RYU控制器相关笔记" target="_blank" rel="external">http://www.li2ui2.xyz/2020/11/20/SDN-%E4%B8%89-RYU%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/li2ui2" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/liwei.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/li2ui2" target="_blank"><span class="text-dark">你的老李同学</span><small class="ml-1x">R&amp;D Engineer</small></a></h3>
        <div>每天都要学习到晕厥</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2020/11/20/SDN-%E4%BA%94-Netgear-R6220%E4%BB%8E%E5%88%B7%E6%9C%BA%E5%88%B0%E9%85%8D%E7%BD%AE-OpenvSwitch%E4%BA%A4%E6%8D%A2%E6%9C%BA/" title="SDN(五) Netgear R6220从刷机到配置 OpenvSwitch交换机"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2020/11/20/SDN-%E4%BA%8C-%E5%AF%B9TP-LINK-TL-MR3420%E5%9E%8B%E5%8F%B7%E7%9A%84OpenFlow%E4%BA%A4%E6%8D%A2%E6%9C%BA%E8%BF%9B%E8%A1%8C%E9%85%8D%E7%BD%AE/" title="SDN(二) 对TP-LINK TL-MR3420型号的OpenFlow交换机进行配置"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/li2ui2" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        &copy; 2022 Li Wei
        
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: true,
    appId: 'C4mjAEf6eUerQGDf0h0RsjNe-gzGzoHsz',
    appKey: 'CUeJRp85k5GiRkjjuOuXggjQ',
    placeholder: '说点什么...',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: true
  });
  </script>

     







</body>
</html>